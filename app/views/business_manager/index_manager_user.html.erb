<p id="notice"><%= notice %></p>

<script src="//maps.google.com/maps/api/js?key=AIzaSyBl4A9FU5D1xHc6wl5GEfY5KGXumWFHy6Q"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->

<div class="layout">

  <div class="nav">
    <a href="#" class="nav__item">
      <%= image_tag "calificacion-empresa-tab.png" %>      
      <span>Calificación de la empresa</span>
    </a>

    <%= link_to index_manager_user_path, class: "nav__item" do %>
      <%= image_tag "calificacion-empresa-tab.png" %>      
      <span>Monitor Empresarial</span>
    <% end %>
    
  </div><!-- .nav -->

  <div class="main">
    <h1>SECTOR <%= @sector.name %></h1>

    <table border="1" cellpadding="1" cellspacing="1" style="width:500px;">
		<tbody>
			<tr>
				<td colspan="2">
					<%= form_tag(index_manager_user_path(), :method => "get", id: "search") do %>
					  <div class="row buscador" style="max-width: none; margin-left: -15px;">
					    <div class="medium-6 columns ordenar-field">

					    	<strong>PUEDES FILTRAR POR: </strong>
					  		<%= select_tag(:level, options_for_select([['Todo', ''],['Regional', 'regional'], ['Municipal', 'municipal']],params[:level]), :onchange => "this.form.submit();") %>
					    
					    	<%= select_tag :location, options_for_select(@municipios.map{|s|[s.name, s.id]},params[:location]) %>

					    	<%= submit_tag "Buscar" %>    
					    </div>
					  </div>
					<% end %>
				</td>
			</tr>
			<tr>
				<td>
					PROVEEDORES
				</td>
				<td colspan="1" rowspan="3">
					<div style='width: 800px;'>
					  <div id="map" style='width: 800px; height: 400px;'></div>
					</div>
					<script type="text/javascript">
						handler = Gmaps.build('Google');
						handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
						  markers = handler.addMarkers(<%=raw @hash.to_json %>);
						  handler.bounds.extendWith(markers);
						  handler.fitMapToBounds();
						});
					</script>
				</td>
			</tr>
			<tr>
				<td>
					COMPETENCIA
				</td>
			</tr>
			<tr>
				<td>
					DISTRIBUIDORES
				</td>
			</tr>
		</tbody>
	</table>

	<div style='width: 800px;'>
	  <div id="map" style='width: 800px; height: 400px;'></div>
	</div>
	<script type="text/javascript">
		handler = Gmaps.build('Google');
		handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
		  markers = handler..addMarkers(<%=raw @hash.to_json %>);
		  handler.bounds.extendWith(markers);
		  handler.fitMapToBounds();
		});
	</script>
	<hr>
	<h2>TOTAL DE EMPRESAS</h2>
	<%= link_to 'DIRECTORIO DE EMPRESAS', business_directory_user_path %>
	<ul>
        <li><a href="#estatal" aria-selected="true">NIVEL ESTATAL</a></li>
        <li><a href="#regional">NIVEL REGIONAL</a></li>
        <li><a href="#municipal">NIVEL MUNICIPAL</a></li>
    </ul><!-- .tabs -->

    <div>

        <div id="estatal">
          <strong>Grafica</strong>
          <%= @companies_all.length %> / <%= @companies_states.length %>

          <h4><%= @sector.name %></h4>
          <h4><%= @companies_states.length %> empresas</h4>

        </div>
          
        <div id="regional">
          
          	<table class="site-table">
		      <thead>
		        <tr>
		          <th>UBICACIÓN</th>
		          <th>NÚMERO DE EMPRESAS</th>
		          <th>PORCENTAJE DEL SECTOR</th>
		        </tr>
		      </thead>

		      <% if @user.company %>
			      <tbody>
			      	<% @municipios_first_five.each do |municipio| %>
				      	<tr>
				      		<td>
				        		<strong><%= municipio.name %></strong><br>
				        		<%= municipio.region.name %>
				        	</td>
				        	<td>
					        	<% @municipio_count = Company.where("municipio_id = ? AND sector_id = ?", municipio.id ,@sector.id).length %>
					        	<%= @municipio_count %> empresas
				        	</td>
				        	<td>
				        		<% if @municipio_count > 0 %>
				        			- <%= @sector.name %> <%= (@municipio_count * 100)/@companies_sectors.length %> %
				        		<% else %>
				        			- <%= @sector.name %> 0 %
				        		<% end %>
				        	</td>
				      	</tr>
				    <% end %>
			      </tbody>
		      <% end %>
			</table>
			<%= link_to 'VER TODAS LAS REGONES', company_regional_user_path %>
        </div>

        <div id="municipal">
          	<div>
	          	<h4>Detalle</h4>
	          	<hr>
	          	<% @company_am_2.each do |company_list| %>
	          		<strong>- <%= (company_list[1] * 100)/@companies_sectors.length %> % / <%= company_list[1] %> empresas</strong> <br>
	          		<%= company_list[0].name %>
	          		<br>
	          	<% end %>
          	</div>
          	<table class="site-table">
		      <thead>
		        <tr>
		          <th>ACTIVIDAD ECONÓMICA</th>
		          <th>NÚMERO DE EMPRESAS</th>
		          <th>SECTOR</th>
		          <th>MUNICIPIO</th>
		        </tr>
		      </thead>

		      <% if @user.company %>
			      <tbody>
			      	<% @company_am_2.each do |company_list| %>
				      	<tr>
				      		<td>
				        		<strong><%= company_list[0].name %></strong>
				        	</td>
				        	<td>
					        	<%= company_list[1] %> empresas
				        	</td>
				        	<td>
				        		<%= company_list[2].name %>
				        	</td>
				        	<td>
				        		<%= company_list[3].name %>
				        	</td>
				      	</tr>
				    <% end %>
			      </tbody>
		      <% end %>
			</table>
			<%= link_to 'VER TODAS LAS ACTIVIDADES ECONÓMICAS', company_municipal_user_path %>
        </div>

    </div>

  </div><!-- .main -->
</div><!-- .layout -->

<%= render "shared/footer" %>